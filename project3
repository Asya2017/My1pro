#include <stdio.h>
#include <stdlib.h>

int main(int argc, char **argv) {
    if (argc < 2) {
        printf("Ошибка: укажите имя файла\n");
        printf("Использование: %s <filename>\n", argv[0]);
        return 1;
    }
    FILE *f = fopen(argv[1], "r");
    if (file == NULL) {
        printf("Ошибка: не удалось открыть файл '%s'\n", argv[1]);
        return 1;
    }
    int A, B;
    if (fscanf(file, "%d %d", &A, &B) != 2) {
        printf("Ошибка: неверный формат данных в файле\n");
        fclose(file);
        return 1;
    }
    if (A <= 0 || B <= 0) {
        printf("Ошибка: неверные размеры матрицы %dx%d\n", A, B);
        fclose(file);
        return 1;
    }
    int **mat = malloc(A * sizeof(int*));
    if (matrix == NULL) {
        printf("Ошибка: не удалось выделить память для матрицы\n");
        fclose(file);
        return 1;
    }
    for (int i = 0; i < A; i++)
        mat[i] = malloc(B * sizeof(int));
        if (mat[i] == NULL) {
            printf("Ошибка: не удалось выделить память для строки %d\n", i);
            for (int j = 0; j < i; j++) {
                free(mat[j]);
            }
            free(mat);
            fclose(file);
            return 1;
        }
    }
    
    for (int i = 0; i < A; i++)
        for (int j = 0; j < B; j++) {
            if (fscanf(f, "%d", &mat[i][j]) != 1) {
                printf("Ошибка: не удалось прочитать элемент [%d][%d]\n", i, j);
                for (int k = 0; k < A; k++) {
                    free(mat[k]);
                }
                free(mat);
                fclose(f);
                return 1;
            }
        }
    }
    fclose(file);

    for (int i = 0; i < (A < 3 ? A : 3); i++) {
        for (int j = 0; j < (B < 3 ? B : 3); j++) {
            printf("%d ", mat[i][j]);
        }
        printf("\n");
    }
    
    int S = 0;
    for (int i = 0; i < (A < B ? A : B); i++)
        S += mat[i][i];
  
    if (A >= 3) {
        int max_i = 0;
        for (int j = 1; j < B; j++)
            if (mat[2][j] > mat[2][max_i])
                max_i = j;
        mat[2][max_i] = S;
    }

    for (int i = 0; i < A; i++)
        free(mat[i]);
    free(mat);
    return 0;
}
